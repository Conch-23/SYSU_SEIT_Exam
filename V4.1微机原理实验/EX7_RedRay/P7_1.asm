;p3_1

ORG    0000H
LJMP   START
ORG	0013H
LJMP	INFARED
ORG	0050H
START:  	MOV   TMOD,#01H   	
MOV   TL0, #00H
MOV   TH0, #00H
MOV	SP, #60H
SETB   	EA
SETB	EX1
SETB	IT1			
CLR		00H
CLR		01H	
CLR		10H
MOV	30H, #00H
MOV	31H, #00H
MOV	32H, #00H
MOV	33H, #00H
DISP:		MOV  	P1, #0E8H		
			MOV 	A, 32H			
MOV	P0, A
LCALL 	DELAY
SJMP	DISP

INFARED:	PUSH	ACC
CLR 	EA				
			LCALL	READ
END_INFA:	CLR		IE1
			SETB	EA
			POP		ACC
			RETI

READ:		;读整条红外信息
READHEAD:	LCALL 	T_LOW			
LCALL 	T_HEAD1		
LCALL 	COMPARE		
JB		00H, END_READ
JB		01H, END_READ	
LCALL 	T_HIGH			
LCALL 	T_HEAD2		
LCALL	COMPARE		
JB		00H, END_READ	
JB		01H, END_READ	
MOV	R1, #30H			
MOV	R2, #4			
READBYTE:	MOV	R3, #8			
CLR		A
READBIT:	RL		A
ACALL	ONEBIT
			MOV	C, 10H
			MOV	ACC.0, C
			DJNZ	R3, READBIT
			MOV	@R1, A
			INC		R1
			DJNZ	R2, READBYTE
END_READ:	RET

T_HEAD1:	MOV 	44H, #34	;数字8755的高8位
MOV 	43H, #51	;数字8755的低8位
MOV	42H, #25	;数字7834的高8位
MOV	41H, #154;数字7834的低8位
RET
T_HEAD2:	MOV 	44H, #18	;数字4608的高8位
MOV 	43H, #0	;数字4608的低8位
MOV	42H, #14	;数字3686的高8位
MOV	41H, #102;数字3686的低8位
RET
T_BIT1:		MOV 	44H, #2	;数字718的高8位
MOV 	43H, #206;数字718的低8位
MOV	42H, #1	;数字313的高8位
MOV	41H, #59;数字313的低8位
RET
T_BIT2:		MOV 	44H, #6	;数字1751的高8位
MOV 	43H, #214;数字1751的低8位
MOV	42H, #5	;数字1345的高8位
MOV	41H, #65	;数字1345的低8位
RET
T_LOW:		;计时低电平时长函数
			MOV	TL0, #00H
 			MOV	TH0, #00H
			SETB	P3.3
			SETB	TR0
			JNB		P3.3, $
			CLR		TR0
			RET
T_HIGH:		;计时高电平时长函数
			MOV   TL0, #00H
        	MOV   TH0, #00H
			SETB	P3.3
			SETB	TR0
			JB		P3.3, $
			CLR		TR0
			RET
COMPARE:	
PUSH	ACC
			CLR		00H 	
			CLR		01H 	
			CLR 	C
			MOV	A, 43H
			SUBB	A, TL0
			MOV	A, 44H
			SUBB	A, TH0
			MOV	01H, C	
			CLR 	C
			MOV	A, TL0
			SUBB	A, 41H
			MOV	A, TH0
			SUBB	A, 42H
			MOV 	00H, C 
			POP		ACC
			RET
ONEBIT:		;读一位二进制数
CLR		10H
			ACALL 	T_LOW
ACALL 	T_BIT1
LCALL 	COMPARE
JB		00H, END_BIT
JB		01H, END_BIT
BIT_0:		ACALL 	T_HIGH
			ACALL 	T_BIT1
LCALL 	COMPARE
JB		00H, END_BIT
JB		01H, BIT_1
			SJMP	END_BIT
BIT_1:		ACALL 	T_BIT2
LCALL 	COMPARE
JB		00H, END_BIT
JB		01H, END_BIT
SETB	10H		
END_BIT:	RET

DELAY:  	MOV	R6, #20
DEL1:   	MOV	R7, #50
DEL2:   	DJNZ	R7, DEL2
			DJNZ   R6, DEL1
        	RET
			END